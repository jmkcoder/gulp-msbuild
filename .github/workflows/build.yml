name: Build

on:
  workflow_call:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check for [skip] in PR title
      id: check_skip
      run: bash .github/scripts/check-skip.sh "${{ github.event.pull_request.title }}"
      
    - name: Verify PR title
      if: env.skip == 'false'
      id: determine_increment
      run: bash .github/scripts/verify-pr-title.sh "${{ github.event.pull_request.title }}" "${{ env.latest_tag }}"

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'

    - name: Install dependencies
      run: npm i

    - name: Build the project
      run: npm run build

    - name: Run tests with coverage
      run: npm run test:coverage

    - name: Check coverage thresholds
      run: bash .github/scripts/check-coverage.sh

    - name: Upload build artifacts
      if: github.event.pull_request.merged == true
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/
